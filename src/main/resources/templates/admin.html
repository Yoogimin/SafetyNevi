<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>SafetyNevi - ì¬ë‚œ ì‹œë®¬ë ˆì´í„°</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Malgun Gothic", "ë§‘ì€ ê³ ë”•", sans-serif; padding: 20px; background-color: #f0f2f5; display: flex; justify-content: center; }
        .container { max-width: 800px; width: 100%; background-color: #fff; padding: 20px 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h1 { text-align: center; color: #333; margin-top: 0; }
        fieldset { border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 25px; background: #fff; }
        legend { font-size: 1.2em; font-weight: 600; padding: 0 10px; }
        .legend-circle { color: #007bff; }
        .legend-polygon { color: #d9534f; }
        .legend-status { color: #28a745; }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #555; }
        .form-group input, .form-group select { width: 95%; padding: 10px 12px; font-size: 14px; border: 1px solid #ccc; border-radius: 5px; }

        .input-group { display: flex; gap: 10px; }
        .input-group input { flex-grow: 1; }
        .input-group button { padding: 0 15px; background-color: #666; color: white; border: none; border-radius: 5px; cursor: pointer; }

        button.simulate-btn { width: 100%; padding: 12px; font-size: 16px; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        #simulate-btn-circle { background-color: #007bff; }
        #simulate-btn-area { background-color: #d9534f; }
        button:hover { opacity: 0.9; }

        /* í˜„í™© í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
        th { background-color: #f8f9fa; font-weight: bold; color: #555; }
        .btn-delete { background-color: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .badge { padding: 3px 8px; border-radius: 12px; color: white; font-size: 11px; font-weight: bold; }

        #result { margin-top: 20px; font-weight: bold; padding: 10px; border-radius: 5px; text-align: center; display: none; }
        #result.success { color: #155724; background-color: #d4edda; display: block; }
        #result.error { color: #721c24; background-color: #f8d7da; display: block; }
    </style>

    <!-- ğŸŒŸ íŒŒë¹„ì½˜ ì¶”ê°€: /img/logo/favicon.png ë° /img/logo/favicon.ico ğŸŒŸ -->
    <link rel="icon" type="image/png" href="/img/logo/favicon.png">
    <link rel="shortcut icon" type="image/x-icon" href="/img/logo/favicon.ico">
</head>
<body>

<div class="container">
    <h1>âš¡ SafetyNevi í†µí•© ê´€ì œì‹¤</h1>

    <fieldset>
        <legend class="legend-status">ğŸš¨ í˜„ì¬ ë°œë ¹ ì¤‘ì¸ ì¬ë‚œ í˜„í™©</legend>
        <div style="text-align: right; margin-bottom: 10px;">
            <button onclick="loadActiveDisasters()" style="background:#28a745; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>ìœ í˜•</th>
                <th>ìœ„ì¹˜/ì§€ì—­</th>
                <th>ì¢…ë£Œ ì˜ˆì •</th>
                <th>ê´€ë¦¬</th>
            </tr>
            </thead>
            <tbody id="disaster-list-body">
            <tr><td colspan="5" style="text-align:center;">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
            </tbody>
        </table>
    </fieldset>

    <hr style="border:0; border-top:1px dashed #ccc; margin:30px 0;">

    <fieldset>
        <legend>1. ì¬ë‚œ ìœ„ì¹˜ ì„¤ì •</legend>
        <div class="form-group">
            <label>ì¤‘ì‹¬ ì£¼ì†Œ ê²€ìƒ‰</label>
            <div class="input-group">
                <input type="text" id="address" placeholder="ì£¼ì†Œë¥¼ ê²€ìƒ‰í•˜ì„¸ìš”" readonly>
                <button id="search-address-btn">ğŸ” ê²€ìƒ‰</button>
            </div>
        </div>
        <input type="hidden" id="lat"><input type="hidden" id="lon"><input type="hidden" id="areaName">
    </fieldset>

    <div style="display: flex; gap: 20px; flex-wrap: wrap;">
        <fieldset style="flex: 1; min-width: 300px;">
            <legend class="legend-circle">2. ì›í˜• ì¬ë‚œ (Point)</legend>
            <div class="form-group">
                <label>ì¬ë‚œ ìœ í˜•</label>
                <select id="type-circle">
                    <option value="missile">ğŸš€ ë¯¸ì‚¬ì¼</option>
                    <option value="fire">ğŸ”¥ í™”ì¬</option>
                    <option value="quake">ğŸŒ‹ ì§€ì§„</option>
                    <option value="lightning">âš¡ ë‚™ë¢°</option>
                    <option value="heavyRain">ğŸŒ§ï¸ í­ìš°</option>
                </select>
            </div>
            <div class="form-group">
                <label>ë°˜ê²½ (m)</label>
                <input type="number" id="radius" value="1500">
            </div>
            <div class="form-group">
                <label>ì§€ì† (ë¶„)</label>
                <input type="number" id="duration-circle" value="30">
            </div>
            <button id="simulate-btn-circle" class="simulate-btn">ì›í˜• ì¬ë‚œ ë°œìƒ</button>
        </fieldset>

        <fieldset style="flex: 1; min-width: 300px;">
            <legend class="legend-polygon">3. ì§€ì—­ ì¬ë‚œ (Area)</legend>
            <div class="form-group">
                <label>ëŒ€ìƒ ì§€ì—­</label>
                <input type="text" id="areaName-display" value="-" readonly style="background:#f9f9f9;">
            </div>
            <div class="form-group">
                <label>ì¬ë‚œ ìœ í˜•</label>
                <select id="type-area">
                    <option value="heavyRain">ğŸŒ§ï¸ í­ìš°</option>
                    <option value="typhoon">ğŸŒ€ íƒœí’</option>
                    <option value="heatwave">â˜€ï¸ í­ì—¼</option>
                    <option value="tsunami">ğŸŒŠ í•´ì¼</option>
                    <option value="fire">ğŸ”¥ ì‚°ë¶ˆ</option>
                </select>
            </div>
            <div class="form-group">
                <label>ì§€ì† (ë¶„)</label>
                <input type="number" id="duration-area" value="60">
            </div>
            <button id="simulate-btn-area" class="simulate-btn">ì§€ì—­ ì¬ë‚œ ë°œìƒ</button>
        </fieldset>
    </div>

    <div id="result"></div>
</div>

<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=d8822c35851508a88d440e6883daef52&libraries=services"></script>

<script>
    // --- 1. ì´ˆê¸°í™” ë° ì£¼ì†Œ ê²€ìƒ‰ ---
    const geocoder = new kakao.maps.services.Geocoder();

    document.getElementById('search-address-btn').addEventListener('click', () => {
        new daum.Postcode({
            oncomplete: function(data) {
                document.getElementById('address').value = data.address;

                // ì§€ì—­ëª… ì¶”ì¶œ (êµ¬/êµ° ë‹¨ìœ„)
                let sigungu = data.sigungu;
                if(!sigungu && data.address.split(' ').length > 1) sigungu = data.address.split(' ')[1];
                document.getElementById('areaName').value = sigungu;
                document.getElementById('areaName-display').value = sigungu;

                // ì¢Œí‘œ ë³€í™˜
                geocoder.addressSearch(data.address, function(result, status) {
                    if (status === kakao.maps.services.Status.OK) {
                        document.getElementById('lat').value = result[0].y;
                        document.getElementById('lon').value = result[0].x;
                    }
                });
            }
        }).open();
    });

    // --- 2. ì¬ë‚œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (í˜„í™©íŒ) ---
    async function loadActiveDisasters() {
        const tbody = document.getElementById('disaster-list-body');
        try {
            const response = await fetch('/api/disaster-zones');
            const data = await response.json();

            tbody.innerHTML = '';
            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#999;">í˜„ì¬ ë°œë ¹ëœ ì¬ë‚œì´ ì—†ìŠµë‹ˆë‹¤. âœ…</td></tr>';
                return;
            }

            data.forEach(item => {
                const tr = document.createElement('tr');

                // ìœ„ì¹˜ ì •ë³´ í‘œì‹œ (ì§€ì—­ëª… or ì¢Œí‘œ)
                let locationText = item.areaName ? `[ì§€ì—­] ${item.areaName}` : `[ì¢Œí‘œ] ${parseFloat(item.latitude).toFixed(4)}, ${parseFloat(item.longitude).toFixed(4)}`;

                // ë‚¨ì€ ì‹œê°„ ê³„ì‚°
                const expiry = new Date(item.expiryTime);
                const now = new Date();
                const diffMin = Math.ceil((expiry - now) / (1000 * 60));
                const timeText = diffMin > 0 ? `${diffMin}ë¶„ ë‚¨ìŒ` : "ì¢…ë£Œë¨";

                // ë±ƒì§€ ìƒ‰ìƒ
                let badgeColor = '#666';
                if(item.disasterType === 'missile') badgeColor = '#dc3545';
                else if(item.disasterType === 'fire') badgeColor = '#fd7e14';
                else if(item.disasterType === 'heavyRain') badgeColor = '#0d6efd';

                tr.innerHTML = `
                    <td>${item.id}</td>
                    <td><span class="badge" style="background:${badgeColor}">${item.disasterType}</span></td>
                    <td>${locationText}</td>
                    <td style="color:${diffMin < 10 ? 'red' : 'black'}">${timeText}</td>
                    <td><button class="btn-delete" onclick="deleteDisaster(${item.id})">ìƒí™© ì¢…ë£Œ</button></td>
                `;
                tbody.appendChild(tr);
            });
        } catch (e) {
            console.error(e);
            tbody.innerHTML = '<tr><td colspan="5" style="color:red;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</td></tr>';
        }
    }

    // --- 3. ì¬ë‚œ ì‚­ì œ (ìƒí™© ì¢…ë£Œ) ---
    window.deleteDisaster = async function(id) {
        if(!confirm(`ID ${id}ë²ˆ ì¬ë‚œ ìƒí™©ì„ ì •ë§ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        try {
            const response = await fetch(`/api/admin/disaster/${id}`, { method: 'DELETE' });
            if(response.ok) {
                alert("ìƒí™©ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadActiveDisasters(); // ëª©ë¡ ê°±ì‹ 
            } else {
                alert("ì‚­ì œ ì‹¤íŒ¨");
            }
        } catch(e) {
            alert("ì˜¤ë¥˜ ë°œìƒ");
        }
    };

    // --- 4. ì‹œë®¬ë ˆì´ì…˜ ìƒì„± ìš”ì²­ ---
    async function createDisaster(url, payload) {
        const resultEl = document.getElementById('result');
        resultEl.className = '';
        resultEl.innerHTML = 'â³ ìš”ì²­ ì²˜ë¦¬ ì¤‘...';

        try {
            const params = new URLSearchParams(payload).toString();
            const response = await fetch(url + '?' + params, { method: 'POST' });
            if(!response.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜");

            resultEl.className = 'success';
            resultEl.innerHTML = 'âœ… ì¬ë‚œ ë°œë ¹ ì„±ê³µ! í˜„í™©íŒì´ ê°±ì‹ ë©ë‹ˆë‹¤.';
            loadActiveDisasters(); // ì„±ê³µ ì‹œ ëª©ë¡ ìë™ ê°±ì‹ 
        } catch (e) {
            resultEl.className = 'error';
            resultEl.innerHTML = 'âŒ ì˜¤ë¥˜: ' + e.message;
        }
    }

    document.getElementById('simulate-btn-circle').addEventListener('click', () => {
        const lat = document.getElementById('lat').value;
        const lon = document.getElementById('lon').value;
        if(!lat) return alert("ì£¼ì†Œë¥¼ ë¨¼ì € ê²€ìƒ‰í•˜ì„¸ìš”.");

        createDisaster('/api/admin/simulate', {
            lat: lat, lon: lon,
            type: document.getElementById('type-circle').value,
            radius: document.getElementById('radius').value,
            durationMinutes: document.getElementById('duration-circle').value
        });
    });

    document.getElementById('simulate-btn-area').addEventListener('click', () => {
        const areaName = document.getElementById('areaName').value;
        if(!areaName) return alert("ì£¼ì†Œë¥¼ ê²€ìƒ‰í•˜ì—¬ ì§€ì—­ëª…ì„ í™•ì¸í•˜ì„¸ìš”.");

        createDisaster('/api/admin/simulate-area', {
            areaName: areaName,
            type: document.getElementById('type-area').value,
            durationMinutes: document.getElementById('duration-area').value
        });
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    loadActiveDisasters();

</script>
</body>
</html>